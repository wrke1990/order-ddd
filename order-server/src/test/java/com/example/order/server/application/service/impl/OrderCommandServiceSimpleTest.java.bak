package com.example.order.server.application.service.impl;

import com.example.order.common.exception.BusinessException;
import com.example.order.domain.model.aggregate.Order;
import com.example.order.domain.model.vo.Id;
import com.example.order.infrastructure.acl.product.ProductClient;
import com.example.order.infrastructure.acl.product.dto.ProductDTO;
import com.example.order.server.application.assember.OrderDtoAssembler;
import com.example.order.server.application.dto.CreateOrderCommand;
import com.example.order.server.application.dto.CreateOrderCommand.OrderItemCommand;
import com.example.order.server.application.dto.OrderResponse;
import com.example.order.server.application.service.ProductValidationService;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.*;

/**
 * 简单的OrderCommandService测试类，不依赖Spring Boot测试框架
 */
public class OrderCommandServiceSimpleTest {

    @Test
    void testCreateOrder() {
        // 手动创建mock对象
        ProductValidationService productValidationService = mock(ProductValidationService.class);
        ProductClient productClient = mock(ProductClient.class);
        OrderDomainService orderDomainService = mock(OrderDomainService.class);
        OrderRepository orderRepository = mock(OrderRepository.class);
        OrderDtoAssembler orderDtoAssembler = mock(OrderDtoAssembler.class);
        UserClient userClient = mock(UserClient.class);
        PaymentClient paymentClient = mock(PaymentClient.class);
        PromotionClient promotionClient = mock(PromotionClient.class);
        FulfillmentClient fulfillmentClient = mock(FulfillmentClient.class);
        OrderEventPublisher orderEventPublisher = mock(OrderEventPublisher.class);

        // 创建测试对象
        OrderCommandServiceImpl orderCommandService = new OrderCommandServiceImpl(
                productValidationService,
                productClient,
                orderDomainService,
                orderRepository,
                orderDtoAssembler,
                userClient,
                paymentClient,
                promotionClient,
                fulfillmentClient,
                orderEventPublisher
        );

        // 测试数据
        CreateOrderCommand command = new CreateOrderCommand();
        CreateOrderCommand.OrderItemCommand item = new CreateOrderCommand.OrderItemCommand();
        item.setProductId(1L);
        item.setQuantity(2);
        item.setPrice(BigDecimal.valueOf(100));
        command.setOrderItems(new CreateOrderCommand.OrderItemCommand[]{item});
        command.setUserId(1L);
        command.setPaymentMethod(1);
        command.setAddressId(1L);

        // 设置mock行为
        when(productValidationService.validateProductsAndStock(command.getOrderItems()))
                .thenReturn(true);

        // 创建产品DTO
        ProductDTO productDTO = new ProductDTO();
        productDTO.setId(1L);
        productDTO.setStock(10);
        productDTO.setPrice(BigDecimal.valueOf(100));

        // 设置批量锁定库存的mock行为
        Map<Id, Integer> productIdQuantities = new HashMap<>();
        productIdQuantities.put(Id.newId(1L), 2);
        when(productClient.lockProductStocks(productIdQuantities)).thenReturn(true);

        // 创建订单对象
        Order order = mock(Order.class);
        when(orderDomainService.createOrder(any())).thenReturn(order);
        when(order.getOrderNo()).thenReturn("ORDER_001");
        when(orderRepository.save(order)).thenReturn(order);

        // 设置转换结果的mock行为
        OrderResponse response = new OrderResponse();
        response.setOrderNo("ORDER_001");
        when(orderDtoAssembler.toOrderResponse(order)).thenReturn(response);

        // 执行测试
        OrderResponse result = orderCommandService.createOrder(command);

        // 验证结果
        assertNotNull(result);
        assertEquals("ORDER_001", result.getOrderNo());

        // 验证方法调用
        verify(productValidationService).validateProductsAndStock(command.getOrderItems());
        verify(productClient).lockProductStocks(productIdQuantities);
        verify(orderDomainService).createOrder(any());
        verify(orderRepository).save(order);
        verify(orderDtoAssembler).toOrderResponse(order);
    }
}